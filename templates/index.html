<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Face Login</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;display:flex;align-items:center;justify-content:center;min-height:100vh;background:#0f172a;color:#e2e8f0}
    .card{background:#111827;border-radius:16px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.35);text-align:center;width:360px}
    button{padding:10px 16px;border-radius:10px;border:0;cursor:pointer}
    .primary{background:#22c55e;color:#0b1419;font-weight:700}
    video{border-radius:12px;width:320px;height:240px;background:#000}
    #msg{margin-top:10px;color:#94a3b8}
  </style>
  <!-- ‚úÖ Add Socket.IO client -->
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
</head>
<body>
  <div class="card">
    <h2>üîê Face Login</h2>
    <video id="video" autoplay playsinline></video>
    <div style="margin-top:12px">
      <button class="primary" onclick="capture()">Login</button>
    </div>
    <p id="msg"></p>
  </div>

  <script>
    const video = document.getElementById('video');
    const msg = document.getElementById('msg');

    // ‚úÖ Initialize socket
    const socket = io();

    // Listen for admin broadcasts
    socket.on("broadcast", data => {
      alert("üì¢ Admin: " + data.message);
    });

    // Camera
    navigator.mediaDevices.getUserMedia({ video: true, audio: false })
      .then(stream => video.srcObject = stream)
      .catch(err => msg.textContent = 'Camera error: ' + err);

    function capture(){
      const c = document.createElement('canvas');
      c.width = 320; c.height = 240;
      const ctx = c.getContext('2d');
      ctx.drawImage(video, 0, 0, 320, 240);
      const dataURL = c.toDataURL('image/jpeg');

      fetch('/login', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ image: dataURL })
      })
      .then(r => r.json())
      .then(d => {
        if (d.status === 'success') {
          window.location.href = '/call?room=lobby';
        } else if (d.status === 'new_face') {
          alert('üë§ New face saved as ' + d.name + '\nClick Login again to proceed.');
        } else {
          window.location.href = '/fail';
        }
      })
      .catch(e => msg.textContent = 'Request error: ' + e);
    }
    socket.on("force-logout", () => {
  alert("‚ö†Ô∏è Admin logged out all users");
  window.location.href = "/";
});
  </script>
</body>
</html>
